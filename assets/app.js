import {api} from './api.js'
function fmt(v){return new Intl.NumberFormat('vi-VN').format(v)}
function qs(k){const u=new URL(location.href);return u.searchParams.get(k)||''}
function getJSON(p){return fetch(p).then(r=>r.json())}
function getCart(){try{return JSON.parse(localStorage.getItem('cart')||'[]')}catch(e){return []}}
function saveCart(c){localStorage.setItem('cart',JSON.stringify(c))}
function addToCart(id,qty){const c=getCart();const i=c.find(x=>x.id===id);if(i){i.qty+=qty||1}else{c.push({id,qty:qty||1})}saveCart(c)}
function updateQty(id,qty){const c=getCart().map(x=>x.id===id?{id:x.id,qty:qty}:x);saveCart(c)}
function removeItem(id){saveCart(getCart().filter(x=>x.id!==id))}
function subtotal(cart,products){return cart.reduce((s,i)=>{const p=products.find(x=>x.id===i.id);return s+(p?p.price*i.qty:0)},0)}
function getCompare(){try{return JSON.parse(localStorage.getItem('compare')||'[]')}catch(e){return []}}
function saveCompare(v){localStorage.setItem('compare',JSON.stringify(v.slice(0,4)))}
function toggleCompare(id,checked){let v=getCompare();if(checked){if(!v.includes(id))v.push(id)}else{v=v.filter(x=>x!==id)}saveCompare(v)}
function renderCard(p){const el=document.createElement('div');el.className='card';const checked=getCompare().includes(p.id);el.innerHTML=`<a href="product.html?id=${encodeURIComponent(p.id)}"><img src="${p.image}" alt="${p.name}"></a><div class="card-body"><div class="title">${p.name}</div><div class="row"><div class="price">${fmt(p.price)}₫</div>${p.original?`<div class="strike">${fmt(p.original)}₫</div>`:''}</div><div class="row"><span class="badge">Trả góp 0%</span></div><div class="row"><label class="row" style="gap:6px"><input type="checkbox" ${checked?'checked':''} data-cid="${p.id}">So sánh</label><a class="btn" href="compare.html">Xem</a></div><button class="btn" data-id="${p.id}">Thêm vào giỏ</button></div>`;el.querySelector('button').addEventListener('click',()=>{addToCart(p.id,1);alert('Đã thêm vào giỏ')});const cb=el.querySelector('input[type=checkbox]');cb.addEventListener('change',()=>{toggleCompare(p.id,cb.checked)});return el}
function filterProducts(list){const debug=qs('debug');if(debug==='1')return list||[];const cat=(qs('cat')||'').toLowerCase();const brand=(qs('brand')||'').toLowerCase();const min=Number(qs('min')||0);const max=Number(qs('max')||0);const sizeMin=Number(qs('sizeMin')||0);const sizeMax=Number(qs('sizeMax')||0);const powerMin=Number(qs('powerMin')||0);const powerMax=Number(qs('powerMax')||0);const tech=(qs('tech')||'').toLowerCase();return (list||[]).filter(p=>{const catOk=!cat||String(p.category||'').toLowerCase()===cat;const brandOk=!brand||String(p.brand||'').toLowerCase()===brand;const priceOk=(!min||Number(p.price||0)>=min)&&(!max||Number(p.price||0)<=max);const sizeOk=(!sizeMin||Number(p.size||0)>=sizeMin)&&(!sizeMax||Number(p.size||0)<=sizeMax);const powerOk=(!powerMin||Number(p.power||0)>=powerMin)&&(!powerMax||Number(p.power||0)<=powerMax);const techOk=!tech||String(p.tech||'').toLowerCase().includes(tech);return catOk&&brandOk&&priceOk&&sizeOk&&powerOk&&techOk})}
function initHome(){const wrap=document.getElementById('home-products');if(!wrap)return;api.getProducts().then(list=>{wrap.innerHTML='';(list||[]).slice(0,10).forEach(p=>wrap.appendChild(renderCard(p)))}).catch(()=>{getJSON('data/products.json').then(list=>{wrap.innerHTML='';(list||[]).slice(0,10).forEach(p=>wrap.appendChild(renderCard(p)))})});const sI=document.getElementById('search-input');const sB=document.getElementById('search-btn');if(sI&&sB){sB.addEventListener('click',()=>{const q=sI.value.trim().toLowerCase();if(!q)return;api.getProducts().then(list=>{const m=(list||[]).filter(p=>p.name.toLowerCase().includes(q));wrap.innerHTML='';m.forEach(p=>wrap.appendChild(renderCard(p)))}).catch(()=>{getJSON('data/products.json').then(list=>{const m=(list||[]).filter(p=>p.name.toLowerCase().includes(q));wrap.innerHTML='';m.forEach(p=>wrap.appendChild(renderCard(p)))});})})}}
function initList(){const wrap=document.getElementById('product-list');if(!wrap)return;if(wrap.dataset.lock==='1'&&wrap.children.length>0){return}const status=document.getElementById('status');if(status)status.textContent='Đang tải...';function render(list){try{const cat=(qs('cat')||'');let filtered=filterProducts(list||[]);wrap.innerHTML='';if(!filtered||filtered.length===0){wrap.innerHTML='<div class="muted">Không có sản phẩm</div>';if(status)status.textContent='0 sản phẩm'+(cat?` cho danh mục ${cat}`:'');return}filtered.forEach(p=>wrap.appendChild(renderCard(p)));if(status)status.textContent=`${filtered.length} sản phẩm`+(cat?` cho danh mục ${cat}`:'');console.log('Rendered products',filtered.length)}catch(e){console.error('Render error',e);if(status)status.textContent='Lỗi render: '+(e&&e.message||'unknown')}}api.getProducts().then(render).catch((e)=>{console.warn('API getProducts failed, fallback to JSON',e);getJSON('data/products.json').then(render).catch((ee)=>{console.error('Fallback JSON failed',ee);if(status)status.textContent='Lỗi tải dữ liệu'})})}

function initDetail(){const wrap=document.getElementById('product-detail');if(!wrap)return;const id=qs('id');api.getProducts().then(list=>{const p=list.find(x=>String(x.id)===String(id));if(!p){wrap.innerHTML='Không tìm thấy sản phẩm';return}const crumbs=`<div class="row" style="margin-bottom:8px"><a href="index.html" class="btn" style="background:#eef2f7;color:#111">Trang chủ</a><span style="opacity:.7">›</span><a href="products.html?cat=${encodeURIComponent(p.category)}" class="btn" style="background:#eef2f7;color:#111">${p.category}</a><span style="opacity:.7">›</span><span>${p.name}</span></div>`;const gallery=(p.images&&p.images.length?p.images:[p.image]);const promos=(p.promos||[]);const specs=p.specs||{};wrap.innerHTML=`${crumbs}<div class="pd-layout"><div class="pd-media"><img id="mainImg" src="${gallery[0]}" alt="${p.name}" class="pd-mainimg"><div class="pd-thumbs">${gallery.map((src,i)=>`<img src="${src}" data-idx="${i}" class="pd-thumb">`).join('')}</div><div class="pd-accordion"><div class="item open"><div class="hd">Thông số kỹ thuật</div><div class="bd pd-specs">${Object.keys(specs).length?'<table>'+Object.entries(specs).map(([k,v])=>`<tr><th>${k}</th><td>${v}</td></tr>`).join('')+'</table>':'Chưa có thông số'}</div></div><div class="item"><div class="hd">Thông tin sản phẩm</div><div class="bd">${p.description||'Đang cập nhật'}</div></div></div><div class="pd-rating"><div class="row"><strong>Đánh giá</strong><span class="muted">${p.rating?p.rating+'/5':''}</span></div><div id="reviews"></div><div class="row" style="margin-top:8px"><input id="rv-name" placeholder="Tên" style="flex:1"><input id="rv-text" placeholder="Nội dung" style="flex:2"><button class="btn" id="rv-add">Gửi</button></div></div></div><div class="pd-info"><h1 style="margin:0 0 8px">${p.name}</h1><div class="pd-price"><div class="current">${fmt(p.price)}₫</div>${p.original?`<div class="old">${fmt(p.original)}₫</div>`:''}</div><ul class="pd-promos">${promos.map(x=>`<li>${x}</li>`).join('')||'<li>Ưu đãi trả góp 0%, giao nhanh</li>'}</ul><div class="pd-actions"><button class="btn" id="buy">Thêm vào giỏ</button><a class="btn" href="checkout.html">Mua ngay</a></div><div class="pd-accordion"><div class="item open"><div class="hd">Giao hàng & lắp đặt</div><div class="bd">${p.delivery||'Giao hàng toàn quốc, hỗ trợ lắp đặt tại các thành phố lớn'}</div></div><div class="item"><div class="hd">Bảo hành</div><div class="bd">${p.warranty||'Bảo hành chính hãng 12 tháng'}</div></div></div></div></div>`;document.getElementById('buy').addEventListener('click',()=>{addToCart(p.id,1);location.href='cart.html'});document.querySelectorAll('img[data-idx]').forEach(t=>t.addEventListener('click',()=>{document.getElementById('mainImg').src=t.src}));document.querySelectorAll('.pd-accordion .hd').forEach(h=>h.addEventListener('click',()=>{h.parentElement.classList.toggle('open')}));function getLS(k){try{return JSON.parse(localStorage.getItem(k)||'[]')}catch(e){return []}}function setLS(k,v){localStorage.setItem(k,JSON.stringify(v))}function renderList(k,el){const list=getLS(k).filter(x=>x.pid===p.id);el.innerHTML=list.map(x=>`<div class="row"><strong>${x.name}</strong><span style="opacity:.7">${new Date(x.ts).toLocaleString('vi-VN')}</span></div><div>${x.text}</div>`).join('')||'Chưa có nội dung';}const rv=document.getElementById('reviews');renderList('reviews',rv);document.getElementById('rv-add').addEventListener('click',()=>{const name=document.getElementById('rv-name').value.trim();const text=document.getElementById('rv-text').value.trim();if(!name||!text)return;const list=getLS('reviews');list.push({pid:p.id,name,text,ts:Date.now()});setLS('reviews',list);renderList('reviews',rv)})})}
function initCart(){const wrap=document.getElementById('cart-items');if(!wrap)return;api.getProducts().then(list=>{const cart=getCart();if(cart.length===0){wrap.innerHTML='Giỏ hàng trống';return}wrap.innerHTML='<table class="table"><thead><tr><th>Sản phẩm</th><th>Giá</th><th>Số lượng</th><th>Tạm tính</th><th></th></tr></thead><tbody id="cart-body"></tbody></table><div class="summary"><div>Tổng cộng</div><div id="cart-total"></div></div><div class="row"><a class="btn" href="checkout.html">Thanh toán</a></div>';const body=document.getElementById('cart-body');cart.forEach(i=>{const p=list.find(x=>x.id===i.id);if(!p)return;const tr=document.createElement('tr');tr.innerHTML=`<td>${p.name}</td><td>${fmt(p.price)}₫</td><td><input type="number" min="1" value="${i.qty}" data-id="${p.id}" style="width:64px"></td><td>${fmt(p.price*i.qty)}₫</td><td><button class="btn" data-rm="${p.id}">Xóa</button></td>`;body.appendChild(tr)});Array.from(body.querySelectorAll('input[type=number]')).forEach(inp=>{inp.addEventListener('change',()=>{const id=Number(inp.getAttribute('data-id'));const qty=Math.max(1,Number(inp.value||1));updateQty(id,qty);initCart()})});Array.from(body.querySelectorAll('button[data-rm]')).forEach(b=>{b.addEventListener('click',()=>{removeItem(Number(b.getAttribute('data-rm')));initCart()})});document.getElementById('cart-total').textContent=fmt(subtotal(cart,list))+'₫'})}
function initCheckout(){const qr=document.getElementById('qr');const total=document.getElementById('total');if(!qr||!total)return;api.getProducts().then(list=>{const cart=getCart();const sum=subtotal(cart,list);total.textContent=fmt(sum)+'₫';const receiver={bankId:'tpbank',accountNumber:'20365905498',accountName:'NGUYEN AN NINH'};const orderCode=qs('orderCode')||('DH'+Date.now());const phone=qs('phone')||'';window.vietqr.render(qr,{...receiver,amount:sum,orderCode,phone,template:'compact'});if(cart.length>0){api.createOrder({items:cart,amount:sum,orderCode,phone,method:'VietQR'}).then(()=>{localStorage.removeItem('cart')})}})}
document.addEventListener('DOMContentLoaded',()=>{initHome();initList();initDetail();initCart();initCheckout()})
document.addEventListener('click',(e)=>{const detail=document.getElementById('product-detail');if(!detail)return;const a=e.target.closest('a[href="checkout.html"]');if(!a)return;e.preventDefault();const id=Number(qs('id')||0);if(id){addToCart(id,1)}location.href='checkout.html'})
function initCompare(){const wrap=document.getElementById('compare');if(!wrap)return;Promise.all([getJSON('data/products.json')]).then(([list])=>{const ids=getCompare();const items=list.filter(p=>ids.includes(p.id));if(items.length===0){wrap.innerHTML='Chưa chọn sản phẩm để so sánh';return}const head=['Tên','Giá','Hãng','Danh mục','Kích thước','Công suất','Công nghệ'];const rows=items.map(p=>[p.name,fmt(p.price)+'₫',p.brand,p.category,p.size||'',p.power||'',p.tech||'']);let html='<table class="table"><thead><tr>'+head.map(h=>`<th>${h}</th>`).join('')+'</tr></thead><tbody>';rows.forEach(r=>{html+='<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>'});html+='</tbody></table>';wrap.innerHTML=html})}
document.addEventListener('DOMContentLoaded',()=>{initCompare()})
