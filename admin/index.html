<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="../assets/admin.css">
</head>
<body>
  <header class="admin-header">
    <div>Admin</div>
    <nav class="admin-nav">
      <a href="products.html">Sản phẩm</a>
      <a href="orders.html">Đơn hàng</a>
      <a href="customers.html">Khách hàng</a>
      <a href="users.html">Người dùng</a>
      <a href="cms.html">Nội dung</a>
      <a href="promotions.html">Khuyến mãi</a>
      <a href="settings.html">Cài đặt</a>
      <a href="reports.html">Báo cáo</a>
      <a href="#" id="logout">Đăng xuất</a>
    </nav>
  </header>
  <main class="container">
    <h2>Tổng quan</h2>
    <div id="kpis" class="grid"></div>
    <h3>Doanh thu 7 ngày</h3>
    <div id="chart" class="chart"></div>
    <h3>Doanh thu theo tháng (12 tháng)</h3>
    <div id="chart-month" class="chart"></div>
    <h3>Doanh thu theo năm</h3>
    <div id="chart-year" class="chart"></div>
    <h3>Sản phẩm bán chạy</h3>
    <div id="top" class="chart"></div>
    <h3>Doanh thu theo danh mục</h3>
    <div id="bycat"></div>
    <h3>Tin tức</h3>
    <div id="news" class="card">Không có thông báo</div>
  </main>
  <script type="module">
    import {auth} from '../assets/auth.js';
    import {api} from '../assets/api.js';
    auth.init();
    if(!auth.requireRole('admin')){location.href='./login.html'}
    document.getElementById('logout').addEventListener('click',()=>{auth.logout();location.href='./login.html'});
    Promise.all([api.getProducts(),api.listOrders(),api.getUsers(),api.getPosts()]).then(([products,orders,users,posts])=>{
      const revenue=orders.reduce((s,o)=>s+(o.amount||0),0);
      const kpis=document.getElementById('kpis');
      kpis.innerHTML=`<div class="card kpi"><div>Sản phẩm</div><strong>${products.length}</strong></div><div class="card kpi"><div>Đơn hàng</div><strong>${orders.length}</strong></div><div class="card kpi"><div>Khách hàng</div><strong>${users.length}</strong></div><div class="card kpi"><div>Doanh thu</div><strong>${new Intl.NumberFormat('vi-VN').format(revenue)}₫</strong></div>`;
      const days=[...Array(7)].map((_,i)=>{const d=new Date();d.setDate(d.getDate()-i);const key=d.toISOString().slice(0,10);const sum=orders.filter(o=>String(o.createdAt||'').startsWith(key)).reduce((s,o)=>s+(o.amount||0),0);return {key,sum}}).reverse();
      const chart=document.getElementById('chart');
      const max=Math.max(...days.map(d=>d.sum),1);
      chart.innerHTML=days.map(d=>`<div class="bar" style="height:${Math.max(8,Math.round(d.sum/max*100))}%" title="${d.key}: ${new Intl.NumberFormat('vi-VN').format(d.sum)}"></div>`).join('');
      const byMonth={};orders.forEach(o=>{const k=(o.createdAt||'').slice(0,7);byMonth[k]=(byMonth[k]||0)+(o.amount||0)});
      const months=[...Array(12)].map((_,i)=>{const d=new Date();d.setMonth(d.getMonth()-i);return d.toISOString().slice(0,7)}).reverse();
      const maxM=Math.max(...months.map(m=>byMonth[m]||0),1);
      document.getElementById('chart-month').innerHTML=months.map(m=>`<div class="bar" style="height:${Math.max(8,Math.round(((byMonth[m]||0)/maxM)*100))}%" title="${m}: ${new Intl.NumberFormat('vi-VN').format(byMonth[m]||0)}"></div>`).join('');
      const byYear={};orders.forEach(o=>{const k=(o.createdAt||'').slice(0,4);byYear[k]=(byYear[k]||0)+(o.amount||0)});
      const years=Object.keys(byYear).sort();
      const maxY=Math.max(...years.map(y=>byYear[y]||0),1);
      document.getElementById('chart-year').innerHTML=years.map(y=>`<div class="bar" style="height:${Math.max(8,Math.round(((byYear[y]||0)/maxY)*100))}%" title="${y}: ${new Intl.NumberFormat('vi-VN').format(byYear[y]||0)}"></div>`).join('');
      const sold={};orders.forEach(o=>{(o.items||[]).forEach(i=>{sold[i.id]=(sold[i.id]||0)+(i.qty||0)})});
      const top=Object.entries(sold).sort((a,b)=>b[1]-a[1]).slice(0,8).map(([id,qty])=>{const p=products.find(x=>x.id===Number(id))||{name:id};return {name:p.name,qty}});
      const maxS=Math.max(...top.map(t=>t.qty),1);
      document.getElementById('top').innerHTML=top.map(t=>`<div class="bar" style="height:${Math.max(8,Math.round((t.qty/maxS)*100))}%" title="${t.name}: ${t.qty}"></div>`).join('');
      const news=document.getElementById('news');
      if(posts.length){news.innerHTML=posts.slice(0,5).map(p=>`<div><strong>${p.title}</strong><div class="muted">${p.content||''}</div></div>`).join('')}
      const catSum={};orders.forEach(o=>{(o.items||[]).forEach(i=>{const p=products.find(x=>x.id===i.id);const cat=p?p.category:'other';catSum[cat]=(catSum[cat]||0)+((p?p.price:0)*(i.qty||0))})});
      document.getElementById('bycat').innerHTML='<table class="table"><thead><tr><th>Danh mục</th><th>Doanh thu</th></tr></thead><tbody>'+Object.entries(catSum).map(([k,v])=>`<tr><td>${k}</td><td>${new Intl.NumberFormat('vi-VN').format(v)}₫</td></tr>`).join('')+'</tbody></table>';
    });
  </script>
</body>
</html>
